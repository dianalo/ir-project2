<?xml version='1.0' encoding='UTF-8'?>
<DOC><DOCNO>  ZF108-673-412  </DOCNO><DOCID>08 673 412.andM;</DOCID><JOURNAL>PC Magazine  August 1990 v9 n14 p415(8)* Full Text COPYRIGHT Ziff-Davis Publishing Co. 1990.andM;</JOURNAL><TITLE>Compile your batch files for added speed with BAT2EXEC.andO;(Utilities) (tutorial)</TITLE><AUTHOR>Boling, Douglas.andO;AttFile:   PCMAG\V09N14\BAT2EXEC.ASM;0 Program:  BAT2EXEC.ASM  Assembler source code.andO;PCMAG\V09N14\BAT2EXEC.COM;2 Program:  BAT2EXEC.COM  Compile your .BAT files.andO;PCMAG\V09N14\BAT2EXEC.DOC;0 Program:  BAT2EXEC.DOC  Documentation.andM;</AUTHOR><SUMMARY>DOS batch files, like other interpreted programs, are oftenextremely slow.andP;  BAT2EXEC, a batch language compiler that readsASCII batch files and produces .COM programs that perform the samefunctions, is presented.andP;  The output .COM program can execute DOScommands, set environment variables and run other programs.andP;  Itshould not be used on AUTOEXEC.BAT or on batch files that runmemory resident programs.andP;  BAT2EXEC compiles batch files bydetermining what command is on each line and then calling aroutine that parses the command into machine code.andP;  A comparisonof an actual batch file and the .COM file created by BAT2EXEC ispresented.andP;  COPYFILE.BAT checks to see if a file exists and thencopies it.andP;  The .COM file performs the same functions but isloaded into memory and executed by DOS' COMMAND.COM.andP;  It does notecho each line to the screen and does not end when the user runsother batch files.andM;</SUMMARY><DESCRIPT>Topic:     Programming InstructionCompilersTutorial.andO;Feature:   illustrationprogram.andO;Caption:   COPYFILE.ASM. (program)BAT2EXEC.BAS. (program)andM;</DESCRIPT><TEXT>Daily PC operations are practically unimaginable without the use of batchfiles.andP;  Everyone has his favorite collection of them, and some users haveconstructed complex batch files, thousands of bytes long, that push the batchlanguage itself to its limits.andP;  Programs that expand the available batch filefunctions, such as Michael Mefford's BATCHMAN (PC Magazine, January 30,1990), encourage users tO make even larger batch files.andP;  BAT2EXEC.COM fullysupports all the BATCHMAN extensions.andM;Unfortunately, however, batch files are also notoriously slow.andP;  It can bealmost painful to watch them scroll down the screen a line at a time.andP;  Astandard way to improve the speed of interpreted programs, like batch files,is to compile them.andP;  And that's where BAT2EXEC enters the picture.andM;BAT2EXEC is a batch language compiler.andP;  It reads your ASCII batch file andproduces a COM format program that performs the same function as the originalbatch file.andP;  Just as with the batch file, the resulting COM program canexecute DOS internal commands and execute other programs.andP;  Environmentvariables and command-line parameters are processed as they would be in theoriginal.andP;  The two files differ mainly in that the resulting COM program willexecute much faster than the original .BAT file.andM;You can download a ready-to-run copy of BAT2EXEC.COM from PC MagNet.andP;  Thesource code (BAT2EXEC.ASM) and a BASIC program (BAT2EXEC.BAS) that willproduce the executable file BAT2EXEC.COM are also available from PC MagNet.andO;The downloading instructions are given in the sidebar &quot;BAT2EXEC by Modem.andP;  &quot;andO;BAT2EXEC.andP;  BAS is also printed here, in case you don't have a modem-but havethe time and patience to key in this listing.andP;  Finally, if you're interestedin assembling BAT2EXEC yourself from its ASM listing, you'll need a macroassembler (IBM or Microsoft, Version 2 or later), and you should enter thefollowing set of commands:andM;MASM BAT2EXEC;andM;LINK BAT2EXEC;andM;EXE2BIN BAT2EXEC BAT2EXEC.COMandM;To create the utility from its BAS listing, just run BAT2EXEC.BAS in BASIC.andM;USING BAT2EXECandM;The full syntax for BAT2EXEC could hardly be simpler.andP;  Just enterandM;BAT2EXEC FLLE.BATandM;where FILE.BAT is the name of your batch file.andP;  BAT2EXEC will then produce anexecutable COM file with the name FILE .COM.andP;  If BAT2EXEC can't find thebatch file, an error message will be printed.andP;  if BAT2EXEC can't understand aline in the batch file, it will print an error message indicating the line inthe file in which it discovered the error.andM;BAT2EXEC should not be used on every batch file.andP;  AUTOEXEC.BAT, for example,must remain a genuine batch file in order for COMMAND.COM to find it.andO;Similarly, batch files that run terminateand-stay-resident utilities (TSRS)should not be compiled.andP;  The reason for this last limitation lies in the DOSmemory management structure: if a TSR is executed from a program compiled byBAT2EXEC, the memory used by BAT2EXEC itself will not be made available tothe system after it terminates.andM;COMPILED VS.andP;  INTERPRETED PROGRAMSandM;To understand what BAT2EXEC does, you must understand the differences betweeninterpreted and compiled programs Both types of programs start out as fileswritten in a specific language, such as C, BASIC, of DOS's batch language,but that's where the similarity ends.andM;In an interpreted program, a separate Program, called an interpreter, readseach line of the program and performs the instruction contained in that line.andO;COMMAND.COM itself has a built-in interpreter that executes batch fileprograms.andP;  Thus, a program statement to print a line to the screen will beread and deciphered by the interpreter, after which the interpreter willprint the line to the screen in the format specified by the print statement.andO;Note that if a loop in the program causes the same line to be reexecuted, theline must again be read, deciphered, and the data printed from scratch.andM;One of the problems with interpreters, then, is that if a line is executedmore than once, the same work of reading and deciphering must be performedagain.andP;  Indeed, all the reading and deciphering interpreters must do takes asmuch time as performing the actual functions called for by the program.andM;Furthermore, even with a simple language (such as the batch language) thereis significant work just to determine the statement being executed.andP;  Forexample, for a batch file simply to run a program, the line must be scannedfor redirection parameters, environment variables must be evaluated, and theprogram name must be compared with all possible internal commands.andP;  Onlyafter all of this can the program be executed.andM;Of course, interpreted programs also have significant advantages.andP;  Theirmajor plus is that they can be created and immediately executed.andP;  You can usea simple ASCII editor to create the program and then try it from the commandline.andP;  In a short program the lack of execution speed is unimportant; it isthe ease of creating and running the program that matters.andP;  Further, if thereis an error in the batch file, the offending line can quickly be changed andthe program run again.andM;Compilers are programs that turn an ASCII file written in a language into astandalone executable file.andP;  All the work involved in determining thefunction of each line is done when the program is initially compiled.andP;  Theresulting program contains only the machine language instructions necessaryto execute the program.andM;The advantages of compiled programs, then, are their speed and ability to runwithout the aid of an interpreter.andP;  Reverting to the example above of a linethat prints a string to the screen, a compiler can simply create the fewinstructions necessary for the program to call the DOS print string command.andO;If this section of code were executed again, only the specific call to DOSwould be executed.andP;  Further (though this does not apply specifically to batchfiles, since they use COMMAND.COM for their interpreter), since compiledprograms execute without the aid of an interpreter, you don't have to buy aninterpreter just to run the program.andM;Using a compiler is not a panacea, however.andP;  Developing a program takes moretime, since the program must be recompiled any time the original is changed.andO;Compiled programs can be hard to debug, since the machine language outputfrom the compiler can be cryptic.andM;The choice between using interpreted programs and compiled programs isusually decided on the basis of how the program will be used.andP;  For quick,simple programs, (such as small batch files) using an interpreter is best.andO;For application programs or complex batch files, using a compiler is a betterbet.andM;BAT2EXEC INTERNALSandM;The .COM file generated by BAT2EXEC consists of a series of calls to a set ofpredefined routines and a data area containing the data used by the routines.andO;The predefined routines perform such standard functions as echoing a stringto the screen, testing the condition of an IF statement, and executinganother program.andP;  BAT2EXEC keeps track of which routines a program needs andincludes only the necessary ones in the COM file.andP;  This keeps the COM file assmall as possible.andM;Overall, BAT2EXEC can be viewed as two separate programs.andP;  The first partconsists of the compiler code.andP;  The compiler parses each line of the batchfile and produces the compiled version of the file.andP;  The rest of BAT2EXECcomprises a collection of routines that perform the functions needed by theresulting .COM file.andM;The batch file is compiled by determining what command is on each line andthen calling the appropriate routine to parse that command.andP;  Individualroutines within BAT2EXEC parse each of the batch commands.andP;  Additionalroutines process external programs, internal COMMAND .COM commands, andlabels.andM;In general, each parsing routine must copy the necessary data into the databuffer, include any called routines, and insert the necessary in-line code tocall the routines.andP;  The routines COPY_STRING, INLINE_CODE, and INCLUDE_CODEperform most of the necessary work.andM;COPY_STRING copies ASCII strings into the data buffer.andP;  This routine alsoreturns a flag if any command-line parameters or environment variables arefound.andP;  The length of the string is returned for routines (such as launchprograms), that create a buffer of defined length.andM;The INCLUDE_CODE routine computes the runtime offsets of any of the cannedroutines required by the source program.andP;  If a canned routine calls otherroutines, INCLUDE_CODE recursively calls itself to include them, as well.andO;Within BAT2EXEC, routines call each other by using a call table associatedwith the routine.andP;  Thus, when a routine is included into the COM file, itscall table is scanned to see whether the routine depends on any otherroutines.andP;  If other routines are needed, those routines are included.andP;  Theruntime offsets of these routines are then loaded into the call table.andP;  Toaddress the table, routines use the CALL instruction to push the startingaddress of the routine onto the stack.andP;  This address is popped into the BXregister and used as an offset to the call table and any local data.andM;INCLUDE_CODE does not include the actual code for a routine; rather, itsimply adds the routine to a list of routines to be included in the outputfile.andP;  After the source file has been parsed, the requisite individualroutines are then assembled in the output file immediately following thesetup code.andP;  Since the setup code and each of the individual canned routineshas a defined length, the runtime offsets of the routines can be determinedbefore the COM file is built.andP;  This offset is what INCLUDE CODE returns tothe parsing routine.andM;INLINE_CODE generates the code necessary to call the included routines.andP;  Theroutine generates MOV, LEA, and MOV immediate opcodes for both SI and DIregisters.andP;  Calls, jumps, and conditional jumps can be appended after theregister loads.andP;  The code is generated by copying code fragments fromBAT2EXEC into the code buffer.andP;  The opcodes are then modified to point to theproper offsets.andP;  The offset of the appropriate canned routine returned byINCLUDE CODE is passed to INLINE_CODE where it is used as the offset for thecall instruction.andM;BY WAY OF ILLUSTRATION ...andM;Perhaps the best way to understand how BAT2EXEC works is to compare twoprograms: an actual batch file and the COM file that BAT2EXEC creates fromit.andP;  Figure I shows a simple .andP;  BAT file that echoes a line to the screen,copies a file (if it exists) to the A: drive, and echoes a line indicatingthat the program is finished.andP;  Error messages are included, and as with anygood program, COPYFILE.BAT is well commented with REM statements.andM;Figure 2 shows a representation of the .COM file output produced by BAT2EXEC.andO;Since COPYFILE.COM itself consists simply of machine code instructions, itwould be nearly impossible to read, so I disassembled it to show the assemblylanguage statements and added comments.andM;When the .BAT file is executed, COMMAND.COM reads it in, one line at a time.andO;Each line is scanned for redirection characters, and then the first word ineach line is read in order to determine the function of the line.andM;The ECHO statement prints a line to the screen, telling the user that thefile will be copied.andP;  The first command-line parameter is substituted for % 1in the string.andM;The IF statement causes COMMAND .COM to check whether the file entered on thecommand line exists.andP;  This line illustrates how command-line parameters (andenvironment variables) can be used at almost any point in a batch file line.andO;If the file exists, the second part of the line-in this case, the jump tolabel LABEL1-is executed.andM;The GOTO statement causes COMMAND.COM to jump to the label and continueexecution from there.andP;  Labels pre sent a problem for batch files; for sincethe COMMAND.COM interpreter does not know where the label is, the entirebatch file must always be reread from the first line until the label isfound.andP;  This search is one of the big reasons batch files are so slow.andM;The COPY function executes just as it would in a batch file.andP;  for hereCOMMAND.COM has the advantage of using one of its own internal functions.andO;Another type of compiled program would need to implement its own copyfunction or call COMMAND.COM to perform the copy for it.andM;The BAT2EXEC-generated.COM file performs the same echo, test, and copyfunctions as would the batch file.andP;  In contrast to operation of the BAT file,however, the COM file is loaded into memory and executed by COMMAND.COM.andP;  The.COM file does not need COMMAND .COM to interpret each line, since it hasbeen transformed (compiled) into machine language by BAT2EXEC.andM;The COM file starts off by setting up its runtime environment.andP;  First, the BPregister is loaded with the starting offset of the .COM file data area.andP;  Thestack pointer is relocated to an area just above the end of the code and thememory allocation is reduced to the minimum needed by the program.andM;BAT2EXEC performs this setup on all programs it compiles, regardless of theircontents.andP;  While some parts of the setup procedure are not always needed,creating a known environment for every program allows all the individualroutines to be written with this environment in mind.andM;The program jumps to the main routine after completing the initial setup.andO;The main routine simply calls each canned routine needed to execute theprogram properly.andP;  After all the requisite routines have been called, theprogram terminates.andP;  The compiled program is efficient because each line doesnot have to be interpreted (and sometimes reinterpreted) to determine itsfunction, since this was done by BAT2EXEC at compile time.andM;The first routine called by the main routine is a procedure that translatesany ASCII string containing command-line parameters or environment variablesinto pure ASCII strings.andP;  This routine is called with SI pointing to theASCII data and DI pointing to one of three temporary buffers located beyondthe code.andP;  The ECHO_MSG routine prints the string to the screen.andM;The TRANSLATE routine is included in the code of Figure 2 because BAT2EXECdetected the command-line parameter % 1 in the echo string of the batch file(Figure 1).andP;  If the string had not contained any command-line parameters (orenvironment variables), the call to the TRANSLATE routine would not have beenincluded.andM;The call to the IF EXIST routine is similar to the ECHO statement call exceptfor the conditional jump after the call.andP;  Since the filename to test containsa command-line parameter, a call is made to the translate routine, as before.andO;Three separate routines are used for the IF statement, depending on the testto be performed.andP;  If the test fails, the program jumps past the code toimplement the rest of the line.andM;Labels, while they do not introduce any code, do have an impact on theprogram compiled by BAT2EXEC.andP;  All labels in the program are organized into alinked list of structures, and a pointer to the start of this list is locatedin the global data section of the .COM file.andP;  The structure for each labelcontains a pointer to the next structure (the ASCII label and its length) anda pointer to the offset in the code at which the label occurred.andM;The GOTO code comes in two flavors.andP;  If the line has no replaceableparameters, a simple JMP instruction is placed in the main routine.andP;  If thegoto contains an environment variable, however, a routine is called to scanthe label list.andP;  Note that this search is much faster than COMMAND.COM'slabel search, since ail labels in the program are tied together by the linksin the list.andP;  When the label is found, the routine replaces the returnaddress on the stack with the new destination read from the label structure.andO;If the label is not found, a message is printed and the routine returns.andM;To execute the internal command COPY, BAT2EXEC executes a copy of COMMAND.COMwith the command line pointing to the command to execute.andP;  COMNUND.COM's /Cswitch is used to execute the command and return.andP;  The routine for executingCOMMAND.COM is quite simple.andP;  First, the environment is searched for theCOMSPEC string, then the launch routine is called to execute the programpointed to by the COMSPEC variable.andM;The launch routine uses the DOS EXEC (function 4Bh) to load and execute aprogram.andP;  Before the program can be executed, the parameter block necessaryfor EXEC is created and all necessary registers are saved.andP;  Since under DOS2.x even the stack register can be changed, the stack pointer is saved aswell.andP;  After the program returns, the return code is retrieved using GetReturn Code of Child Process (function 4Dh).andP;  This return code is saved in abyte in the global data area so that it can be accessed by the IF statementERRORLEVEL routine.andM;The program terminates when it has completed all calls in the main routine.andO;A call is made to the DOS function Terminate Process with return code.andP;  Filescompiled by BAT2EXEC always return an error code of zero.andM;OPERATIONAL DIFFERENCESandM;Programs created by BAT2EXEC behave slightly differently from their originalbatch files.andP;  The COM file doesn't echo each line to the screen as does thebatch file.andP;  Running other batch files doesn't cause the COM program to end.andO;Also, pressing Ctrl-Break does not present the message, &quot;Terminate Batch file(y/n).andP;  &quot; If Ctrl-Break is pressed and BREAK has been set on, the programsimply ends.andM;The resulting COM file is somewhat larger than the batch file.andP;  Compiling abatch file containing a single REM statement results in a COM file size of 68bytes, illustrating the overhead of the setup and terminate routines.andO;Program size increases quickly as routines are added, then slower, as theloaded routines are reused instead of new ones being added.andM;Certainly, BAT2EXEC is not suitable for use on every batch file.andP;  Two- andthree-line batch files are best left in their easy-to-alter andsimple-to-understand ASCII format.andP;  However, for those batch files that havegrown into long complex programs, BAT2EXEC is the answer.andM;PC UTILITIES BY MODEMandM;The programs published in PC Magazine are available by modem from PC MagNet.andM;to join PC MagNet, set your communications software for wither 300 of 1,200bits per second, 7 data bits, even parity, 1 stop bit, and full duplex.andP;  Tofine the number nearest your dialing exchange, dial (800) 346-3247.andP;  When themodem connects, press Enter.andP;  At the HOST NAME prompt, enter PHONES.andP;  followthe menus and note the number closest to you.andM;After you have found the phone number nearest you, hang up and redial usingthat number.andP;  When you connect with PC MagNet, press Ctrl-C.andP;  At the HOSTNAME prompt, enter CIS.andP;  At the USER ID prompt, enter 177000,5000.andP;  EnterPC*MAGNET at the PASSWORD prompt and Z10D9014 at the ENTER AGREEMENT NUMBERprompt.andP;  For Customer Service, call (800) 848-8990; outside the UnitedStates, call (614) 457-8650.andM;To download BAT2COM.COM and/or its assemble language source listing and BASIClisting, log on to PC MagNet.andP;  Enter GO UTILITIES or choose PC MAGAZINEUTILITIES from the top menu,  then DIRECT UTILITY DOWNLOAD from the nextmenu.andP;  Enter the filename, then select the file you want to download fromthose presented.andP;  Answer yes (Y) to DO YOU WISH TO DOWNLOAD? Press Enter tosee the transfer protocols.andP;  Choose a protocol and download the file.andM;You don't have to be a member of CompuServe to access PC MagNet.andP;  It costs$12.80 and hour for 1,200/2,400-bps service and $6.30 for 300-bps, viaMasterCard, VISA, or American Express.andP;  These programs can be copied but arecopyrighted and are made available only for noncommercial use.andP;  You may makecopies for others as long as no charge is involved, but making copies for anycommercial purpose is prohibited.andM;Like all good software, the programs presented in PC Magazine are upgradedand improved.andP;  The only way to obtain the modified versions is to downloadthem from PC MagNet.andP;  Here is a partial list of the programs that have beenupgraded to fix minor bugs and system incompatibilities;andM;ANSI.COM, Version 1.3andM;BEN51.EXE (PC Labs Benchmark Series, Release 5.1)andM;CARDFILE.COM, Version 1.1andM;CHKFRAG.EXE, Version 1.2 (the upgraded program now works with volumes greaterthan 32MB)andM;DIRMATCH.COM, Version 1.1andM;EMS40.SYS, Version 1.1 (fixes a problem with Lotus 1-2-3)andM;LITES.COM, Version 1.1andM;LOG.COM, Version 1.1andM;PCMANAGE.EXE, Version 1.1andM;RN.COM, Version 2.0 (now works under DOS 4.x)andM;SLICE.COM, Version 1.3andM;SNIPPER.COM, Version 1.2andM;ZCOPY.COM, Version 1.2andM;For a complete list of all the programs available from the PC MagNetUtilities Database, download UDCAT .ARC.andM;A downloadable index to PC Magazine's product reviews is also available.andO;PCM.EXE is a self-extracting file that contains the Computer Library PCMagazine Reviews Index for January 1988 to June 1989.andP;  This easy-to-usedatabase is a subset of the Computer Library Periodicals Database, which isavailable on CD-ROM and on PC MagNet.andP;  It requires the search files inPCSRCH.EXE.andM;PCSRCH.EXE is a self-extracting archive containing the software used toretrieve citations form the PC Magazine Reviews Index.andP;  Please read theinformation file PCM.INF before you download any of these files.andM;(Listings and other figures omitted)</TEXT></DOC>