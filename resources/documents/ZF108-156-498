<?xml version='1.0' encoding='UTF-8'?>
<DOC><DOCNO>  ZF108-156-498  </DOCNO><DOCID>08 156 498.andM;</DOCID><JOURNAL>Dr. Dobb's Journal  Feb 1990 v15 n2 p28(9)* Full Text COPYRIGHT Mandamp;T Publishing 1990.andM;</JOURNAL><TITLE>Three-dimensional graphics using the X Window System. (technical)</TITLE><AUTHOR>Stroyan, Michael.andM;</AUTHOR><SUMMARY>The layering of the Starbase graphics library above the X WindowSystem version 11 (X11) Xlib library enables the reasonably fastgeneration of good three-dimensional (3D) graphics in the X WindowSystem environment on workstations.andP;  The X Window System offersimproved portability of graphics programs, but there has beenlittle support of 3D graphics in the windowing environment.andP;  Thenew Starbase on X11 driver enables the provision of variedgraphics capabilities, performance ranges and portability levelsto applications requiring 3D graphics.andP;  Xlib calls offer the bestportability and can implement most features of available 3Dgraphics libraries, including Starbase, GKS, and others.andP;  Mappingof 3D graphics images to the two-dimensional X Window Systemdisplay, use of polygon drawing routines, color map support andhidden surface removal are discussed.andM;</SUMMARY><DESCRIPT>Product:   X Window System (Computer program) (usage).andO;Topic:     Three-Dimensional GraphicsImage ReconstructionFunctionsWindowingTwo-Dimensional GraphicsImage Encoding.andO;Feature:   illustrationchartprogram.andO;Caption:   Drawing a polygon with a hole in it. (chart)Listing one: an example of three-dimensional graphics using Xlib.andO;(program)Listing three: an Xlib double buffering utility. (program)andM;</DESCRIPT><TEXT>Three-Dimensional Graphics Using the X Window SystemandM;The X Window System gives a new level of portability to graphics programs.andP;  Xis available on many workstations.andP;  It is supported by X terminals, and by Xserver programs that can be run on PCs.andP;  There are several toolkits availableto assist with the implementation of graphical user interfaces on X, butthere is little support for three-dimensional graphics using X.andP;  This articlediscusses the options for creating 3-D graphics programs.andP;  It describes theexperience of porting a 3-D graphics library to X, some of the issues thatcame up, and the solutions to those issues.andP;  An example program shows some ofthese solutions.andM;Approaches to Three-DimensionalandM;GraphicsandM;Three-dimensional graphics are created within X11 windows using a variaety ofapproaches.andP;  These options include normal Xlib calls, 3-D graphics libraries(using either Xlib or a peer-level interface that cooperates with an X serverto get directly to the hardware), and extensions to X11 that increase theserver's capabilities.andP;  Each approach has advantages and disadvantages thatmake it appropriate in different circumstances.andM;Using the normal two-dimensional Xlib graphics to render transformed pointsis the most direct method.andP;  Conversion from 3-D to 2-D coordinates is done ina client program that uses Xlib commands to draw the 2-D results.andP;  Thesecommands to the X server are either parts of the picture (such as vector andpolygon primitives), or an entire picture (such as an XPutImage command).andO;Using the X server to render vectors and polygons reduces the complexity ofthe task and improves program performance.andM;The rendering capabilities of the X server are limited, however.andP;  Moresophisticated images can only be created by computing the complete image in aclient program and sending that image to the server as an array of pixelvalues.andP;  When writing a program for use in X Windows, Xlib calls may be thebest choice.andP;  Programs written for X Windows often use such features as Xtoolkits to take full advantage of the window system.andP;  Once tied to thewindow system by these features, there is little reason to use standardgraphics libraries.andP;  The Xlib intrinsics are the only commonly availableinterface for graphics in X Windows.andP;  Putting all 3-D features in the programsource allows (potential) portability of the program to all systems withXlib.andP;  Using a 3-D graphics library limits the program to systems that havethat library.andP;  The amount of extra effort involved to use only Xlib routinesvaries with the nature of the program.andP;  A CAD program may require a number ofextra routines for transformation and input operations that a 3-D graphicsstandard library would have supplied.andP;  A ray tracing program, however,produces a list of pixel values that easily work with the XPutImageoperation.andM;A slightly more difficult approach is implementing a 3-D graphics librarythat is layered above Xlib.andP;  Implementing a standard involves adapting thefeatures of X to suit the required behavior of the standard.andP;  Matching all ofthe features requires additional work.andP;  This extra effort pays off becausemany existing programs that rely on this standard can then be used in XWindows.andP;  A few such libraries have been created.andP;  Hewlett-Packard has addedXlib-based X11 support to the HP Starbase and HP Graphical Kernel System(GKS) libraries.andP;  An X11 implementation of the GKS standard has been createdat the University of Illinois at Urbana-Champaign.andP;  Template Graphics hasproduced an Xlib implementation for their Figaro PHIGS library.andM;A peer-level library has a very different relationship to the X server.andP;  Thistype of library arranges direct access to the display either by using Xserver extensions, or by using the low-level resource allocation utilitiesalso used by the X server.andP;  The direct hardware access approach gives alibrary superior speed and broader use of hardware capabilities than anXlib-based implementation.andP;  This is especially important for graphicsworkstations that support operations such as transforms, hidden surfaceremoval, and shading in specialized hardware.andP;  A peer-level librarysacrifices the networking capability of X.andP;  Programs using such a librarymust run on the same system that they display their output on.andO;Hewlett-Packard uses this type of library for the Starbase and GKS librarieson HP-UX, and for the Domain graphics libraries on HP/Apollo workstations.andM;The X11 protocol has a mechanism for defining new groups of features, called&quot;extensions.&quot;andP;  An X server implementation could provide an extension thatprocesses and renders three-dimensional data.andP;  The MIT X Consortium issponsoring a 3-D graphics extension named PEX (PHIGS Extensions to X).andP;  ThePEX extension will provide support for PHIGS in the X protocol.andP;  A serversupporting PEX will be able to render PHIGS primitives.andP;  The server will alsohave the option of providing support for storing groups of primitives in theserver.andP;  This will allow complicated images to be edited and redrawn withoutretransmitting all the data from the client program to the display server.andP;  Asample implementation of PEX should be ready sometime near December of 1990.andO;It will take additional time for vendors to provide efficient PEXimplementations.andP;  Vendors of X servers on limited hardware, such as Xterminals, may never choose to provide the PEX extensions.andM;The Approach TakenandM;Hewlett-Packard has produced several libraries to assist with the creation of3-D graphics in the X Window System.andP;  These libraries use both the peer-levelinterface approach and the layered Xlib approach for Starbase and GKSlibraries.andP;  Prototypes of the PEX extension approach were demonstrated at theSIGGRAPH '88 and SIGGRAPH '89 conferences.andP;  The rest of this articleconcentrates on implementing a device driver to layer the Starbase graphicslibrary above the Xlib library.andP;  The techniques developed to implement this&quot;Starbase on X11,&quot; or &quot;sox11&quot; driver, apply to creating other libraries andprograms that display 3-D graphics using Xlib.andM;Transformations and ClippingandM;Transforming 3-D coordinates to 2-D coordinates is a well-understood process.andO;Matrix operations are applied to the 3-D coordinates to perform rotations,translations, and perspective projections.andP;  These techniques are described inmany computer graphics reference books, including those listed in thebibliography.andP;  The sox11 driver relies on existing utilities in the Starbaselibrary to perform transformations and clipping.andM;The program in Listing One (page 92) uses three matrices to processcoordinates through modeling, viewing, and device scaling transformations.andO;The modeling matrix is made of a concatenation of rotations about the X and Yaxes.andP;  The matrix is updated to follow mouse movements.andP;  The viewing matrixis precomputed to show a perspective view looking at the origin, from a pointat (0, 0, - 15).andP;  It maps the world coordinates into virtual devicecoordinates (VDCs), ranging from (0, 0, 0) to (2, 2, 2).andP;  The device matrixmaps VDC units to device coordinates -- the window coordinates of Xlib.andM;The VDC to device coordinate transformation is slightly different for X thanfor most other devices because the size of the X Window &quot;device&quot; can change.andO;The sox11 driver leaves the device coordinate transformation unchanged when awindow is resized.andP;  If a window shrinks, the driver shows a &quot;porthole&quot; intoan image larger than the window.andP;  An application programmer can watch forresize events and update device mapping to match the new window size.andP;  Thisgives a &quot;rubber sheet&quot; effect -- the image stretches to match the size of thewindow.andP;  In the program in Listing One, the device transformation matrix isupdated whenever the window size changes so that the image maps to the newwindow size.andP;  There is no clipping code in this example; it relies on theobject being within the viewing volume.andM;Partial PolygonsandM;To improve performance, sox11 uses X server polygon drawing routines to drawpolygons.andP;  This causes a problem with some polygons.andP;  The Starbase graphicslibrary supports polygons with holes in them by defining primitives calledpartial polygons.andP;  (The PHIGS graphics standard calls these groups ofpolygons &quot;Fill Area Sets.&quot;)  The program in Listing One shows a cube with ahole in one side.andP;  The hole in the face of the cube is a partial polygon.andO;Polygons with holes in them are described as a group of partial polygons,followed by a normal polygon.andP;  Each polygon or partial polygon is a loop ofvertices.andP;  These loops may be the outside edges of separate areas, or theoutside and inside edges of a single polygon.andP;  Xlib does not explicitlysupport holes in polygons.andP;  To use Xlib polygon routines and produce thedesired result, the sox11 driver rearranges the vertices and relies on adetail of the definition of Xlib polygons.andM;X protocol defines that drawing a polygon only affects the pixels that arewithin the interior, or on an edge other than the right and bottom edges.andO;This allows adjacent polygons to share common edges without both polygonsaffecting the pixels on the common edges.andP;  A mesh of vertices drawn with anexclusive OR won't leave gaps between polygons.andP;  As a result, if a polygon ispinched down so that two edges are on the same coordinates, no pixels arechanged along the pinched area.andP;  All of the pixels are on a right or bottomedge and are therefore left alone.andP;  If such a double edge crosses theinterior of a polygon, there is no gap where the edges cross the interior.andM;When asked to draw a complex polygon, the sox11 driver connects the partialpolygons to each other by one of these thin double edges.andP;  The result is thatone loop of vertices drawn by XFillPolygon appears to be multiple disjointedloops.andP;  If the polygon is edged, the edges are later drawn along the edges ofthe partial polygon loops with an XDrawLines call for each smaller loop.andO;figure 1 shows an example polygon.andP;  This polygon is defined to Starbase as apartial polygon, with the vertices numbered 1, 2, 3, 4, and 5; followed by apolygon with vertices numbered 6, 7, 8, 9, and 10.andP;  The X server is sent oneXFillPolygon request with all of the vertices from 1 to 11.andP;  Then the edgesare sent as two XDrawLines calls with the vertices of the Starbase partialpolygon and polygon calls.andM;Color Map SupportandM;X protocol deals with many different types of hardware, each of which has avariety of methods for representing and controlling colors.andP;  X protocolcategorizes the representation of colors into six different visual classes:StaticGray, GrayScale, StatiColor, PseudoColor, TrueColor, and DirectColor.andO;These classes indicate whether a display interprets pixel values as levels ofbrightness or as indices into tables of colors.andP;  They also indicate whetherany color tables have writable entries, and whether the bits in a pixel aregrouped into particular bits that determine the red, green, and bluebrightness of a color.andP;  Some displays, such as the HP Turbo SRX, supportmultiple visual classes at the same time.andP;  The sox11 driver supports all sixclasses of visuals, but I will only discuss the PseudoColor class, because itraises the most interesting issues.andP;  A PseudoColor class visual indicatesthat pixel values are indices into a writable table of colors, called a&quot;color map.&quot;andM;The Starbase library, like most graphics standards, is based on a model ofcontrolling a virtual device.andP;  One result is that the library presents colormaps as being completely available to application programs.andP;  The Xlib conceptof color maps is different.andP;  Xlib knows that many programs will be executingon one display, and usually must share a single hardware color map.andO;Reconciling these two approaches to color maps can be done in two differentways.andP;  Either the library's color indices can be mapped to a different set ofallocated Xlib indices, or a new software color map can be allocated by Xlibfor the exclusive use of the sox11 driver.andM;The allocation of individual indices is unsatisfactory if an application usesBoolean pixel changing functions to combine colors on the display.andP;  A programmay expect to OR together a red color in index 1 and a green color in index 2to produce a yellow color that it set in index 3.andP;  Rearranged color indiceswill not necessarily produce the expected result.andM;Allocating a complete color map also has drawbacks.andP;  Because most displaysonly support one color map at a time, the server switches the hardware colormap to correctly display the current window.andP;  All other windows are thendisplayed with essentially random colors.andP;  This can be visually jarring,making the rest of the windows more eye catching than the supposed center ofinterest.andM;The sox11 driver uses some of each color method to avoid most of theweaknesses of each method.andP;  The driver starts by using the default X colormap.andP;  It then allocates a new color map if a program changes any of the colormap entries.andP;  This means a Starbase program can share the common defaultcolor map, as long as it doesn't care about the index values of each color.andO;When a program needs to control the color of particular indices, a full colormap is used, which gives the program complete control.andM;When a color map is allocated, sox11 uses some color map tricks to replacemissing Xlib features.andP;  The Starbase library defines a control called&quot;display enable.&quot;andP;  This selects the bits in a pixel that are used to indexinto a color map.andP;  When looking up a color, those bits that are not displayenabled are read as zero.andP;  Several HP displays provide this control inhardware, but the X protocol does not have this feature.andP;  The sox11 driversimulates hardware display enable by rewriting the color map.andP;  Thus allindices that differ only by bits in display disabled planes have the samecolor.andM;The display enable feature can be used for double buffering.andP;  In doublebuffering, bits in a pixel are divided into two sets.andP;  Half of the bits holdthe image that is being displayed, while the other half are cleared andredrawn to create a new image.andP;  With double buffering, the transition fromdisplaying one image to displaying the next is extremely fast.andP;  When theundisplayed image is ready, the color map is rewritten and the new image isdisplayed in completed form.andP;  There is no flicker while the image ischanging.andP;  This is important for animation, where images are being constantlyupdated.andM;Listings Two (page 98) and Three (page 98) show the header declarations andcode for an Xlib double buffering utility.andP;  This allocates colors from ashared color map, then maps the program's pixel indices to the valuesreturned from Xlib.andP;  The utility will only work with PseudoColor classvisuals, and will only succeed if there are sufficient free pixels toallocate from the color map.andM;Hidden Surface RemovalandM;When drawing 3-D objects as wireframe outlines, removal of hidden lines ishelpful, but not vital, to the perception of the objects' structures.andO;Perspective projection and the motion of vertices during rotations give cluesabout thedistance of points.andP;  When drawing objects with solid faces, removalof surfaces appearing behind other surfaces is very important.andP;  The imageonly makes sense to our eyes if &quot;hidden surfaces&quot; remain hidden.andM;The sox11 driver does not perform hidden surface removal.andP;  An applicationprogram using either Xlib or the sox11 driver can do some hidden surfaceremoval before drawing polygons.andP;  A program can detect and remove the facesof objects that are directed away from the viewer.andP;  A vector pointingperpedicularly out from the face (a &quot;normal&quot;), is either entered as part ofthe object data, or computed from the vertices of each face.andP;  Perspectivetransformation is applied to this normal vector.andP;  If the resulting vector hasa negative Z component, then the face is on the back of the object as seenfrom this viewing position.andP;  The back faces can be removed, because theyshould never be visible.andP;  Back face removal detects all hidden surfaces of asingle convex object, but won't always be sufficient for multiple or morecomplicated objects.andM;Another hidden surface removal method that can be applied by an applicationprogram using the sox11 driver is called the &quot;painterhs algorithm.&quot;andP;  Thisconsists of sorting the polygons in an object so that the most distant aredrawn first.andP;  When two polygons overlap each other on the display, the closerpolygon will be drawn last and will cover up the more distant one.andP;  The facesof the object drawn by the example program in Listing One have been sorted sothat the painter's algorithm applies to those faces that are not back faces.andO;For more general objects, an actual sorting of the faces is required.andM;The painter's algorithm fails if faces pierce through each other or if agroup of faces are arranged to form a cycle of overlapping polygons.andP;  If faceA hides part of face B, face B hides part of face C, and face C hides part offace A, the polygons cannot be sorted.andP;  Another technique must be used.andP;  Twopossible methods are scan line hidden surface removal or Z buffering.andP;  To useeither of these techniques with Xlib requires that the conversation fromvectors and polygons to scan lines or pixels be done by the client program,instead of the X server.andP;  If an application must handle graphics of suchcomplexity, an approach different than layering on Xlib may have to be used.andO;Peer-level interface Starbase drivers perform these hidden surface removaloperations quickly, using hardware scan conversion and Z buffering.andM;SummaryandM;The X Window System produces reasonably fast and visually acceptable 3-Dgraphics.andP;  Depending on application requirements, the existing Xlibgraphicsinterface, extensions to the X photocol, or coexisting peer-level 3-Dgraphics libraries can be used to provide a variety of capabilities,performance ranges, and portability levels.andP;  Xlib calls, which provide thebest portability among the currently available X implementations, can be usedto implement most features of existing 3-D graphics libraries.andM;BibliographyandM;Foley, J.D., and Van Dam, A. Fundamentals of Interactive Computer Graphics,Reading, Mass.:  Addision-Wesley, 1982.andM;Jones, O. Introduction to the X Window System, Englewood Cliffs, N.J.:andO;Prentice-HAll, 1989.andM;Newman, W.M., and Sproull, R.F.andP;  Principles of Interactive Computer Graphics,New York, N.Y.: McGraw-Hill, 1973.andM;Nye, A. Xlib Programming Manual for Version 11, Newton, Mass.: O'Reilly andAssociates, 1988.andM;Rogers, D. F., and Adams, J. A. Mathematical Elements For Computer GraphicsNew York, N.Y.: McGraw-Hill, 1976.andM;AvailabilityandM;All source code is available on a single disk and online.andP;  To order the disk,send $14.95 (Calif.andP;  residents add sales tax) to Dr. Dobb's Journal, 501Galveston Dr., Redwood City, CA 94063, or call 800-356-2002 (from insideCalif.) or 800-533-4372 (from outside Calif.).andP;  Please specify the issuenumber and format (MS-DOS, Macintosh, Kaypro).andP;  Source code is also availableonline through the DDJ Forum on CompuServe (type GO DDJ).andP;  The DDJ ListingService (603-882-1599) supports 300/1200/2400 baud, 8-data bits, no parity,1-stop bit.andP;  Press SPACEBAR when the system answers, type: listings(lowercase at the log-in prompt.andM;Michael is a programmer with the Graphics Technology Division ofHewlett-Packard Company and can be reached at 3404 E. Harmony Rd., MS/73,Fort Collins, CO 80525.andO;</TEXT></DOC>