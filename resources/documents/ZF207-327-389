<?xml version='1.0' encoding='UTF-8'?>
<DOC><DOCNO>  ZF207-327-389  </DOCNO><DOCID>07 327 389.andM;</DOCID><JOURNAL>PC Magazine  March 14 1989 v8 n5 p315(11)* Full Text COPYRIGHT Ziff-Davis Publishing Co. 1989.andM;</JOURNAL><TITLE>Your free software breakout box. (diagnoses transmission problemsbetween computer and RS- 232-compatible peripherals)(includesrelated article on RS-232 standard of communications)</TITLE><AUTHOR>Prosise, Jeff.andO;AttFile:   PCMAG\V08N05\LITES.ASM;0 Program:  LITES.ASM  Breakout box (source).andO;PCMAG\V08N05\LITES.BAS;0 Program:  LITES.BAS  Breakout box (BASIC).andO;PCMAG\V08N05\LITES.COM;2 Program:  LITES.COM  Software breakout box.andO;PCMAG\V08N05\LITES.DOC;0 Program:  LITES.DOC  LITES.COM breakout box.andM;</AUTHOR><SUMMARY>LITES.COM is a software alternative to the expensive breakout boxused by technicians to diagnose a transmission problem with anRS-232-compatible peripheral.andP;  A typical application might belocating the source of the problem when a computer screen goesblank after a modem or serial printer is attached.andP;  LITES is amemory resident utility that monitors the status of relevantRS-232 pins.andP;  It also monitors and displays the communicationsparameters for which the serial port is initialized and which ofits four input control pins and two output control pins are sethigh.andP;  The communications parameters are the data rate, parity,number of data bits and number of stop bits.andP;  The LITES displaycan be called up on-screen by the ALT-L keys.andP;  User type-inlistings are supplied in BASIC and assembly language.andM;</SUMMARY><DESCRIPT>Topic:     Type-In ProgramsSerial TransmissionUtilitiesRS232 InterfaceCommunications SoftwareBASICAssembly Language.andO;Feature:   illustrationprogram.andO;Caption:   Source code for LITES.COM. (program)LITES.BAS will automatically create LITES.COM. (program)andM;</DESCRIPT><TEXT>YOUR FREE SOFTWARE BREAKOUT BOXandM;The dancing lights on your modem provide welcome reassurance that bits ofdata are flowing to or from your PC.andP;  But all too often when you connect aperipheral--a modem, a printer, or a laptop computer--to one of your serial(COM) ports, it just sits there, silently mocking all the trouble you havealready taken to get the correct 9- or 25-pin cable and adapter.andM;Fixing the problem when two RS-232-compatible devices (discussed in thesidebar &quot;RS-232 Standard Communications&quot;) won't talk to each other is usuallyas easy as finding which DIP switches to flip or which program options toselect.andP;  But knowing where to look isn't at all easy when there is &quot;nothing&quot;going on.andM;To diagnose what is happening when nothing seems to be, technicians use adevice known as a breakout box.andP;  In a breakout box, an array of LEDs isconnected to all the important wires in the calbe, so the status of any pincan be determined at a glance.andP;  If the Clear to Send line or any other pinshould be set high and isn't, that fact becomes obvious when its LED fails tolight up.andM;A breakout box is a costly solution to what is probably an infrequentproblem, however.andP;  And fortunately, with very few limitations, it can bestimulated through software.andP;  The LITES utility presented here does this andmore.andP;  LITES is a memory-resident program that monitors the status ofcritical RS-232 pins while other programs run in the foreground.andP;  Inaddition, it tells you the communications parameters--data rate, parity,number of data bits, and number of stop bits--for which your serial port isinitialized and which of its four input control pins and two output controlpins are asserted (set high) at any given time.andP;  With LITES, therefore, youwill be able to diagnose those sticky asynchronous I/O problems withouthaving to resort to buying expensive hardware or exploring trial-and-errorsolutions.andM;LITES.COM can be downloaded from PC MagNet, as explained in the accompanyingsidebar &quot;LITES by Modem.&quot;andP;  The assembly language source code, LITES.ASM, isprinted here, as is LITES.BAS, a BASIC program that will automatically createLITES.COM when your run it once in BASIC.andP;  Both LITES.ASM and LITES.BAS canalso be downloaded from PC MagNet.andM;USING LITESandM;The syntax for LITES is simply LITES [comport] [U] where comport is thenumber of the COM port to be monitored (1 for COM1, 2 for COM2, and so on).andO;If you don't designate a comport, LITES defaults to COM1.andP;  Running LITES withan uppercase or lowercase U following the program name will uninstall apreviously loaded copy of the program.andP;  You'll need to do this when you wantto switch from monitoring one COM port to monitoring another.andP;  [Note: do notuse/U, which will simply bring up the &quot;usage&quot; error message.andP;  LITES does notuse the &quot;slash&quot; delimiter--Ed.]  If a subsequently loaded TSR has stolen awayone or more of the interrupts LITES uses, thereby precluding a safedeinstallation, LITES will give you a &quot;Cannot uninstall&quot; message.andM;Once the utility is loaded, Alt-L brings up the LITES display, and pressingAlt-L a second time removes it.andP;  By default, the LITES status line appears inthe upper-right-hand corner of your screen.andP;  Figure 1 shows how theindicators are organized.andP;  The panel in the rightmost corner indicates theparameters in effect at the serial port.andP;  (The data rate is measured in bitsper second, or bps--and is often incorrectly called the baud rate.)andP;  If theport is set to 1,200 bps with no parity, 8 data bits, and 1 stop bit, LITESwill display 1200 N81.andP;  If the rate indicator reads zero, then the UART (theUniversal Asynchronous Receiver/Transmitter chip at the heart of the serialport) hasn't been initialized.andP;  Some BIOSs initialize the UART to a defaultsetting when you boot up, while others do not.andP;  Each of the screen readoutsis constantly updated so that a change in data rate or data format will bereflected instantly in the on-screen display.andM;In addition to monitoring the UART itself, LITES also monitors the RS-232pins DTR, DSR, RTS, CTS, DCD, and RI.andP;  These are diagramed in Figure 2 andmore fully explained in the &quot;RS-232 Standard Communications&quot; sidebar.andP;  LITESindicates that a pin is asserted (turned &quot;On&quot;--that is, set to logic 1voltage) by displaying its name on the status line.andM;If you install LITES from the DOS command line and immediately press Alt-L topop up the status line, you probably won't see any pins asserted unlessyou've got a powered-up modem attached to the COM port that LITES ismonitoring.andP;  Most Hayes Smartmodems and Hayes-compatible modems permanentlyassert CTS in full-duplex mode and may keep other pins asserted as well,depending upon exactly how the modem's configuration switches are set.andM;To watch LITES in action, turn your modem off and toggle the LITES displayon.andP;  Then flip the modem's power switch on.andP;  With most modems you'll see CTS,DSR, DCD, and RI twinkle to life as the modem conducts a short power-on test,after which RI will turn off.andP;  If you're using a Hayes Smartmodem 1200 withthe configuration switches in the default factory settings, CTS, DSR, and DCDwill remain asserted.andP;  If switch 6 is set to its up position, DCD and DSRwill disappear after a few seconds.andM;Now use the DOS MODE command to change the data rate of the serial port andwatch the LITES status line change in response.andP;  For example, if LITES ismonitoring COM1, enter MODE COM1:9600,E,7,2andM;The LITES display will switch to 9600 E72.andP;  If you now enter MODECOM1:1200,N,8,1andM;LITES will show 1200 N81.andM;The only limitation of a utility like LITES is that its sampling rate islimited by the relatively low frequency of the PC's timer tick interrupt.andP;  Ina complex RS-232 exchange, pin voltages may change several hundred times persecond.andP;  LITES samples the pins several times per second and updates thedisplay each sample period, but it can't hope to trap high-speed voltagefluctuations.andP;  LITES therefore doesn't attempt to monitor the TD (TransmittedData) and RD (Received Data) lines, which show the actual data flow.andP;  Ittakes a hardware-implemented breakout box to do that, or if you're using aSmartmodem, you can watch the SD and RD lights.andM;In most serial communications sessions, however, the control pins DTR, DSR,RTS, CTS, and DCD remain low or high for extended periods, giving LITESplenty of time to display an accurate indication of what's going on at theRS-232 interface level.andM;UNDER THE HOOD LITESandM;LITES is a relatively simple TSR that patches itself into two interruptchains--8 and 9--to enable background operation.andP;  Intercepting interrupt 9lets it monitor the keyboard and watch for you to press Alt-L to pop it up ordown.andP;  If the LITES display is activated, at each occurrence of interrupt 8(the PC's hardware-generated timer tick, which is called about 18.2 times persecond), LITES grabs control of the machine, checks the status of the UART,and updates the on-screen status line.andM;To determine the UART's data format setting, data rate, and the state of itscontrol pins, LITES reads a series of values directly from the UART itself.andO;The UART contains 11 8-bit internal registers, 10 of which can be accessedthrough ports mapped into the PC's I/O address space.andP;  The diagram in Figure2 illustrates the register mapping and the meanings of the bits in registerspertinent to LITES.andP;  LITES obtains the UART's base I/O address from a tablein the BIOS data area that begins at hex address 0040:0000.andP;  The first wordcontains the location of the UART associated with COM1, the second word thelocation of the COM2 UART, and so on up to the number of serial portsinstalled in the machine.andM;The data rate, in bits per second, is determined by dividing the UART's1.8432-MHz input clock frequency by a 16-bit value read from the LSB (LeastSignificant Byte) and MSB (Most Significant Byte) Divisor Latch registers,then dividing the result by 16.andP;  Setting the UART's bit rate for datatransmission or receiving is a matter of doing just the opposite--writing aninteger divisor to the Divisor Latch registers.andP;  That's what the BIOS doeswhen called on to initialize the UART to a desired data rate throughinterrupt 14h.andM;Data format information is obtained from the lower six bits of the LineControl register.andP;  The parity designator appears in bits 3-5, a code for thenumber of stop bits in bit 2, and a code for the number of data bits in bits0 and 1.andP;  The highest bit of this register is known as the Divisor LatchAccess Bit, or DLAB for short.andP;  This is used as an additional register-selectaddress line that allows four registers to share two I/O ports.andP;  When DLAB is0, the ports at the UART's base address and at the base address + 1correspond to the Receiver/Transmitter and Interrupt Enable registers,respectively.andP;  When DLAB is 1, the same ports are logically connected to theLSB and MSB Divisor Latch registers.andM;LITES obtains the status of CTS, DSR, RI, and DCD from the UART's ModemStatus register.andP;  Bits 4-7 represent the absolute state of each pin, and bits0-3 report changes since the register was last read.andP;  A pin is asserted whenthe bit corresponding to it is 1.andP;  Reading this register clears the lowerfour bits.andP;  The states of RTS and DTR are read from bits 0 and 1 of the ModemControl register at the base address+4.andM;Since LITES must not permanently alter the contents of any UART registers butmust nonetheless manipulate DLAB to gain access to the Divisor Latchregisters, it saves the contents of Line Control on entry and restores themon exit.andP;  Before returning control to the process it has interrupted, LITESupdates the status line by displaying bits per second, data format, and thenames of any pins that were asserted when read.andP;  For maximum speed, screenupdates are accomplished by writing directly to video memory.andP;  If LITESdetects that it is running on a Color Graphics Adapter, it synchronizesaccesses to the video buffer with horizontal retrace intervals of the rasterscan to avoid producing unsightly snow.andM;TWO REAL-WORLD PROBLEMSandM;To see how LITES can help you solve real problems, let's consider twosituations that are typical of those you're likely to encounter when usingRS-232 interfaces.andM;Many programs that output data to serial printers use BIOS interrupt 14h.andO;The BIOS's asynchronous I/O routines assert DTR and RTS before a byte istransmitted, then the routines wait for the printer (or other device at thereceiving end) to respond by asserting DSR and CTS.andP;  Only when it sensesthese signals will the BIOS transmit the byte that is pending.andM;Most serial printers designed to work with IBM PCs understand what the BIOSrequires and permanently assert both DSR and CTS.andP;  But not all serialprinters were designed with the IBM PC in mind.andP;  One user ran intodifficulties when he attached a 1983-vintage printer to his PC via a serialcable.andP;  The printer powered on correctly and ran its self-diagnostic testswithout error, but it refused to print anything sent from the PC.andP;  Analysiswith a breakout box revealed that the printer properly asserted CTS each timeit was ready to receive another byte of data, but that it left DSR low.andO;Without seeing DSR asserted to indicate that the printer was ready, the PCwouldn't budge.andM;The solution: a special serial printer cable that looped the PC's DTR outputline back into its own DSR input.andP;  Thereafter, when DTR went high, DSR wentwith it, and the PC's dependence on DSR was effectively bypassed.andP;  Had LITESexisted when this problem was encountered, it would have made short work ofsolving it since it monitors both CTS and DSR.andM;A problem that LITES did help diagnose was one involving the CARDFILE utilitythat appeared in this space in our October 13, 1987, issue.andP;  Several readerscomplained that when they used the program to dial a phone number, itinexplicably replied that their modem wasn't ready.andP;  CARDFILE was written ona system equipped with a Hayes Smartmodem 1200 and thoroughly tested bothduring and after its development, and a review of the program's code revealedno obvious reasons why it shouldn't work.andM;Enter LITES.andP;  CARDFILE used BIOS interrupt 14h to transmit the string &quot;ATDT&quot;,followed by a phone number, to the Smartmodem to instruct it to dial thephone.andP;  With the modem's configuration switches on their factory settings,CARDFILE performed without a hitch--the BIOS routines asserted DTR and RTS,the modem asserted DSR and CTS, and the string was sent flawlessly to themodem.andP;  But if switch 6--which permanently asserts DCD in its default downposition but lets DCD float in the up position--was toggled up, CARDFILEwouldn't dial.andM;Under normal circumstances, CARDFILE should have had no dependence whatsoeveron the DCD pin.andP;  But LITES revealed that in the Hayes Smartmodem 1200 andmany compatibles, DSR follows DCD.andP;  Since DCD doesn't go high until after themodem dials a number and a carrier link is established, neither DCD nor DSRwas asserted when the CARDFILE utility raised DTR and RTS and attempted totransmit the dial command.andP;  As a result, the BIOS timed out trying to sendthe first byte of the command string--and the CARDFILE utility, sensing theerror return from the BIOS, reported that the modem wasn't ready for use.andM;Once again, DSR was the culprit.andP;  Knowing this, we found a simple solution:make sure switch 6 was down before using CARDFILE to dial a number on a HayesSmartmodem 1200 or compatible.andP;  Or as an alternative, you can modify theCARDFILE utility so that it will ignore DSR and rely solely on CTS.andM;CUSTOMIZING LITESandM;As shown in Figure 3, LITES.COM contains several patch points that allow youto customize its operation.andP;  The byte at offset 0160h in the .COM file, forexample, lets you change the hotkey from Alt-L to Alt with any other key.andO;Just substitute the new hotkey's scan code for the default value of 26h.andP;  Akeyboard layout complete with scan codes is shown in Figure 4.andM;In addition to changing the hotkey itself, you can also change the Shift keyor keys that go with it to define the hotkey combination.andP;  Figure 5summarizes the values that correspond to every possible combination of Alt,Ctrl, Left Shift, and Right Shift.andP;  The default Alt-L combination, forinstance, can be changed to Ctrl-Alt-L by replacing the byte at offset 01A0hwith the value 6.andM;The easiest way to make such modifications is with DOS's DEBUG utility.andP;  Forexample, to change LITES to pop up with Ctrl-F1, just follow this script:DEBUG LITES.COM E 0160 3B E 01A0 4 W QandM;The first line invokes DEBUG from the DOS prompt and loads LITES.COM forediting.andP;  The second line uses DEBUG's Enter command (E) to change the valueat offset 0160h in the COM file to 3BH--the hexadecimal scan code forfunction key F1.andP;  DEBUG always thinks in hex, never in decimal.andP;  The nextline, E 0 1A0 4, enters the code for the Ctrl key into the shift mask byte atoffset 01A0h.andP;  The W command then writes the modified program file back todisk, and Q ends DEBUG and drops you back out to the DOS command line.andM;If you change the hotkey's scan code, you'll also want to change the portionof the message displayed when LITES is installed that says &quot;Hotkey is Alt-L.&quot;andO;To do this, simply enter a new string up to 8 bytes in length beginning atoffset 0155h.andP;  For example, the text &quot;Alt-L&quot; would be changed to &quot;Ctrl-F1&quot;with the following sequence: E 0155 &quot;Ctrl-F1&quot;andM;Anything you put inside quotation marks following DEBUG's Enter command isinterpreted literally.andP;  In this case, DEBUG enters the ASCII string &quot;Ctrl-F1&quot;at 0155h.andP;  After this is done and the modified .COM file is saved, LITES willannounce that the &quot;Hotkey is Ctrl-F1&quot; when loaded.andM;By default, LITES's status line is displayed in black characters against afield of white in the upper-right-hand corner of your screen--row 0, offset 0columns from the right margin.andP;  The default black-on-white video attribute isfound at offset 0161h, the row number at 0162h, and the columnar offset at0163h.andP;  To change LITES's colors, replace its default video attribute with avalue whose upper fourbits represent the desired background color and whooselower four bits represent the desired foreground color.andP;  The table in Figure6 lists each of the 16 colors available on a color system and the numbersthat correspond to them.andM;If, for example, you have a color system and want LITS's status line toappear in white-on-red rather than black-on-white, use the DEBUG command E0161 4F to effect the change.andP;  The value 4Fh is the new video attribute.andP;  Thenumeral 4 represents the color red (the background color), and F is the hexcode for intensified white (the foreground color).andP;  You can choose any valuefrom 0 through 7 for background, and any value from 0 through F forforeground.andM;To change the location at which LITES pops up, simply modify the values forcolumn offset and row, which are at offsets 0163h and 0162h.andP;  The row thatLITES uses for its display can be varied from 0 to 24 on most displays.andP;  Thecolumn offset moves the status line the designated number of columns awayfrom the right edge of the screen.andM;LITES taps into your PC's timer tick interrupt to read the UART chip andupdate the display.andP;  The byte at 0164h determines how often this occurs.andP;  Thedefault value of 2 makes LITES act every second timer tick, or about ninetimes every second.andP;  You can tweak this value to adjust the length of timebetween LITES refreshes in increments of 1/18 second.andP;  The highest resolutionyou can achieve is with a value of 1.andP;  The trade-off between this and lessfrequent updates is that the more often LITES is called to update thedisplay, the greater the amount of overhead incurred and the less work getsdone by the computer.andP;  When you're diagnosing transmission problems, use avalue of 1 or 2.andP;  If LITES is loaded purely for educational purposes,consider upping the timer value to 9, so updates will be made only every 1/2second.andM;The final patch point is the byte that determines LITES's default COM port.andO;If no comport entry is made on the command line, LITES defaults to the COMport value stored at offset 0165h.andP;  Unlike the LITES command line, on whichCOM1 would be designated by an ASCII 1, the BIOS thinks of COM1 as portnumber 0.andP;  In changing the default with DEBUG, a value of 0 corresponds toCOM1, a value of 1 corresponds to COM2, 2 corresponds to COM3, and so on.andM;For safety's sake, always work on a copy of a program you wish to modify.andO;And after you make changes with DEBUG, remember to save the edited versionwith the W command before exiting with Q.andP;  If you don't save your changes,they will be lost.andP;  DEBUG Won't automatically save them for you.andM;So, next time you have transmission problems when your PC is connected to amodem, a printer, or even another computer with a serial cable, don't throwyour hands up in frustration.andP;  Most asynchronous RS-232 interactions turn outto be relatively simple when you turn on LITES to illuminate the situation.andM;RS-232 STANDARD COMMUNICATIONSandM;The rapid transfer of bits between your computer and your modem is madepossible in the first instance by a tiny chip in your serial port called aUART, or Universal Asynchronous Receiver/Transmitter.andP;  Within the computer,all the bits in a byte of data travel down the bus simultaneously, inparallel.andP;  The UART decodes data pulled off the computer's internal bus,frames if into a packet with designated number of data bits and stop bits andthe proper parity bit, and transmits these bits sequentially (that is, inserial fashion) at a precise rate.andP;  For incoming data, the UART does theexact opposite; that is, it transforms raw bit streams into easilydecipherable byte-sized chunks.andM;The UART, though an indispensable part of serial communications, does notdictate just how pieces of equipment are to be connected.andP;  This is the taskof the RS-232 standard.andP;  Revision C of the Recommended Standard 232 (knownsimply as RS-232C) is a widely circulated but unfortunately incompleteelectrical specification published by the Electronics Industries Association.andO;The standard defines the 25 interchange circuits used to transfer serialbinary data between a terminal and a modem in synchronous or asynchronousfashion.andP;  These 25 circuits correspond to the 25 pins found on a DB-25 serialport connector.andP;  Of the 25, only a handful are needed for asynchronous I/O,however.andP;  Thus, the serial ports found on many microcomputers, includingthose on the IBM PC AT, contain only the 9 pins commonly used in asynchronousdata exchange.andM;Two pins--TD and RD, for Transmitted Data and Received Data--are used totransmit and receive data.andP;  A byte sent from the computer's serial porttravels over TD one bit at a time (hence &quot;serial communications&quot;) to themodem.andP;  Bits returned by the modem are sent over RD.andP;  A third pin is used asa signal ground.andM;Other pins, such as RTS and CTS (for Request to Send and Clear to Send), areused exclusively for line control.andP;  In half-duplex handshaking, a computerwill assert RTS before transmitting a bit over TD to tell the modem on thereceiving end that it is ready to transmit.andP;  The computer then waits for themodem to respond by asserting CTS.andP;  The modem is programmed to assert CTSwhen it senses that the RTS line has gone high, as long as no internal actionis pending or in progress that would prevent it from properly receiving thedata.andP;  Then it enters a loop waiting for the data to arrive.andM;That seems simple enough.andP;  But one of the problems with RS-232 is thatalthough pin assignments are well defined and their intended functionsclearly documented, people can still implement the hardware and software inslightly different ways.andP;  For example, while the RTS and CTS lines cancontrol the flow of data bits between two devices, the RS-232C standardprovides an additional pair of control lines that are sometimes used andsometime not.andP;  The DTR (Data Terminal Ready) and DSR (Data Set Ready) pinsare sometimes used at the computer and modem ends, respectively, to providewhat is essentially an &quot;I'm here&quot; signal independent of RTS and CTS.andP;  If aprogram for driving a serial printer expects the printer to assert Data SetReady when it's ready for another byte of data, but the printer asserts CTSinstead, the printer will appear dead when in reality it's just not gettingdata from the computer.andP;  That's the kind of thing that LITES is particularlyuseful in catching.andM;Furthermore, RS-232 stops short of defining standards for interchange betweentwo pieces of equipment that both qualify as &quot;terminals&quot; or, in the languageof RS-232, Data Terminal Equipment (DTE).andP;  RS-232 expects to find a DTE (acomputer) on one end and a modem, or Data Communication Equipment (DCE) unit,on the other.andP;  Real-world interfacing frequently involves linking DTEs innonstandard RS-232 configurations.andP;  This is the result, for example, ofconnecting a laptop to a desk-top computer for direct data transfer via anull-modem cable.andP;  The null-modem cable crosses some pins and shorts otherstogether in such a way that a DTE looks like a DCE device.andP;  Unfortunately,however, this is a variation on RS-232 not described by the specification.andO;Nor does RS-232 address the wiring of serial printer cables.andM;LITES is a troubleshooting tool that places a glass window over the unseenworld of the RS-232 port and the UART chip that drives it.andP;  For additionalbackground on the subject of the RS-232 standard, see the PC Lab Notes columnthat appeared in PC Magazine, January 17, 1989, entitled &quot;The AsynchronousAdapter and RS-232.&quot; For further reading, refer to richard Hale Shaw's &quot;ThePC User's Guide to Modems,&quot; PC Magazine, November 29, 1988.andP;  Reading both ofthese articles will help you gain a better understanding of LITES.andO;</TEXT></DOC>